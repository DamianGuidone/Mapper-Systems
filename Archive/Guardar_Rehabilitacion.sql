/* Guardar Rehabilitacion */
====================================================================================================
exec cot_execute_command @cod_command=1283,@patterns='policyId,tempCero,moveId,typeMove,nroPropInt,nroPropExt,nroCot,esManual',@values='50614011|4100317|4|603|123456|''''|''''|-1',@query=default,@proc=1
    EXEC cot_separator_command @patterns, @values, @SQL OUTPUT
        EXEC @isValid = usp_validar_query @v_val
        EXEC @isValid = usp_validar_query @v_val
        EXEC @isValid = usp_validar_query @v_val
        EXEC @isValid = usp_validar_query @v_val
        EXEC @isValid = usp_validar_query @v_val
        EXEC @isValid = usp_validar_query @v_val
        EXEC @isValid = usp_validar_query @v_val
        EXEC @isValid = usp_validar_query @v_val
        emi_usp_rehabilitacion_poliza 50614011, 4100317, 4, 603, 0, 123456, '', '', -1, 0;
            EXEC sp_fecha_mov_suc @fec_emi, 1, 3, 1, @fecha_real = @fec_emi OUTPUT
                INSERT INTO @t EXEC dbo.usp_get_fecha_tope_modulo @cod_modulo
            SELECT @vig_desde = CONVERT(VARCHAR(10),fec_vig_desde,103) + ' ' + CONVERT(VARCHAR(10),fec_vig_desde,108), @vig_hasta = CONVERT(VARCHAR(10),fec_vig_hasta,103) + ' ' + CONVERT(VARCHAR(10),fec_vig_hasta,108), @imp_cambio = dbo.emi_fn_get_currency_change(cod_moneda, getdate()) /* Req. 77280 LFREIRE */ FROM pv_header WHERE id_pv = @id_pv_ult_endo
            EXEC emi_usp_rehabilitacion_riesgos @id_pv, @id_pv_cero, @sn_manual
                IF dbo.fn_Coinsured_Wkf(@id_pv) = -1
                EXEC emi_recuperar_datos_riesgo_dview @id_pv_wkf = @id_pv, @id_pv_endo = @id_pv_recup
                    set @where = ' where ' + DBO.dview_getwhere(@id_view,@id_pv_wkf,0)
                    exec CargarVistasDinamicasEmision @id_pv_endo, @cod_ramo, @cod_usuario, @id_pv_wkf
                UPDATE dc SET fec_vig_desde = CASE WHEN tmp.fec_vig_desde <= ph.fec_vig_desde THEN ph.fec_vig_desde ELSE tmp.fec_vig_desde END ,fec_vig_hasta = CASE WHEN tmp.fec_vig_hasta >= ph.fec_vig_hasta THEN ph.fec_vig_hasta ELSE tmp.fec_vig_hasta END ,cod_estado = case when cod_estado = 'A' then 'A' else 'R' end FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv /* La funcion devuelve una tabla con las fechas de inclusion de la cada cobertura */ INNER JOIN dbo.fn_GetCoberVigencia(@id_pv_cero,@id_pv,DEFAULT) tmp ON tmp.cod_item = dc.cod_item AND tmp.cod_ind_cob = dc.cod_ind_cob WHERE dc.id_pv = @id_pv
            EXEC emi_spc_datos_agente @id_pv
                EXEC dbo.revisa_importe_emision_tempdb_core
                EXEC emi_sp_calcula_comis @id_pv_wkf, @pje_comis_normal, @pje_comis_extra, @ind_agente, @ind_comis_nuevo, @cod_criterio_comis
                    EXEC dbo.revisa_importe_emision_tempdb_core
                    SET @importe_partic = dbo.RedondeaImporteEmision((@prima_neta * (@pje_participacion/100)), @cod_moneda)
                    SET @importe_comis_normal = dbo.RedondeaImporteEmision((@importe_partic * (@pje_comis_normal/100)), @cod_moneda)
                    SET @importe_comis_extra = dbo.RedondeaImporteEmision((@importe_partic * (@pje_comis_extra/100)), @cod_moneda)
                    SET @importe_partic_eq = dbo.RedondeaImporteEmision(((@prima_neta * (@pje_participacion/100)) * @imp_cambio), 0)
                    SET @importe_comis_normal_eq = dbo.RedondeaImporteEmision(((@importe_partic * (@pje_comis_normal/100)) * @imp_cambio), 0)
                    SET @importe_comis_extra_eq = dbo.RedondeaImporteEmision(((@importe_partic * (@pje_comis_extra/100)) * @imp_cambio), 0)
                EXEC emi_sp_calcula_comis @id_pv_wkf, @pje_comis_normal, @pje_comis_extra, @ind_agente, @ind_comis_nuevo, @cod_criterio_comis
                    EXEC dbo.revisa_importe_emision_tempdb_core
                    SET @importe_partic = dbo.RedondeaImporteEmision((@prima_neta * (@pje_participacion/100)), @cod_moneda)
                    SET @importe_comis_normal = dbo.RedondeaImporteEmision((@importe_partic * (@pje_comis_normal/100)), @cod_moneda)
                    SET @importe_comis_extra = dbo.RedondeaImporteEmision((@importe_partic * (@pje_comis_extra/100)), @cod_moneda)
                    SET @importe_partic_eq = dbo.RedondeaImporteEmision(((@prima_neta * (@pje_participacion/100)) * @imp_cambio), 0)
                    SET @importe_comis_normal_eq = dbo.RedondeaImporteEmision(((@importe_partic * (@pje_comis_normal/100)) * @imp_cambio), 0)
                    SET @importe_comis_extra_eq = dbo.RedondeaImporteEmision(((@importe_partic * (@pje_comis_extra/100)) * @imp_cambio), 0)
                EXEC emi_sp_calcula_comis @id_pv_wkf, @pje_comis_normal, @pje_comis_extra, @ind_agente, @ind_comis_nuevo, @cod_criterio_comis
                    EXEC dbo.revisa_importe_emision_tempdb_core
                    SET @importe_partic = dbo.RedondeaImporteEmision((@prima_neta * (@pje_participacion/100)), @cod_moneda)
                    SET @importe_comis_normal = dbo.RedondeaImporteEmision((@importe_partic * (@pje_comis_normal/100)), @cod_moneda)
                    SET @importe_comis_extra = dbo.RedondeaImporteEmision((@importe_partic * (@pje_comis_extra/100)), @cod_moneda)
                    SET @importe_partic_eq = dbo.RedondeaImporteEmision(((@prima_neta * (@pje_participacion/100)) * @imp_cambio), 0)
                    SET @importe_comis_normal_eq = dbo.RedondeaImporteEmision(((@importe_partic * (@pje_comis_normal/100)) * @imp_cambio), 0)
                    SET @importe_comis_extra_eq = dbo.RedondeaImporteEmision(((@importe_partic * (@pje_comis_extra/100)) * @imp_cambio), 0)
                EXEC emi_sp_calcula_comis @id_pv_wkf, @pje_comis_normal, @pje_comis_extra, @ind_agente, @ind_comis_nuevo, @cod_criterio_comis
                    EXEC dbo.revisa_importe_emision_tempdb_core
                    SET @importe_partic = dbo.RedondeaImporteEmision((@prima_neta * (@pje_participacion/100)), @cod_moneda)
                    SET @importe_comis_normal = dbo.RedondeaImporteEmision((@importe_partic * (@pje_comis_normal/100)), @cod_moneda)
                    SET @importe_comis_extra = dbo.RedondeaImporteEmision((@importe_partic * (@pje_comis_extra/100)), @cod_moneda)
                    SET @importe_partic_eq = dbo.RedondeaImporteEmision(((@prima_neta * (@pje_participacion/100)) * @imp_cambio), 0)
                    SET @importe_comis_normal_eq = dbo.RedondeaImporteEmision(((@importe_partic * (@pje_comis_normal/100)) * @imp_cambio), 0)
                    SET @importe_comis_extra_eq = dbo.RedondeaImporteEmision(((@importe_partic * (@pje_comis_extra/100)) * @imp_cambio), 0)
            EXEC emi_genera_solicitud @id_pv
                EXEC dbo.revisa_importe_emision_tempdb_core
                EXEC spi_RE_sumas_reasegurar @id_pv, -1, @id_pv
                    EXEC spi_RE_sumas_reasegurar_param_endo @id_pv_wkf, @id_pv_cero
                    EXEC spu_RE_sumas_reasegurar_param @id_pv_wkf
                EXEC emi_usp_ajusta_prima_mov @id_pv
                    EXEC dbo.revisa_importe_emision_tempdb_core
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE di_pagador_wkf SET imp_participa_me = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100), @cod_moneda) /* avillagran */ ,imp_participa_eq = dbo.RedondeaImporteEmision((@prima_cober * @pje_participa / 100 * @imp_cambio), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv AND cod_item = @cod_item AND cod_ind_cob = @cod_ind_cob AND cod_ind_pagador = @cod_ind_pagador AND cod_aseg = @cod_aseg
                    UPDATE pv_importe_wkf SET imp_prima = dbo.RedondeaImporteEmision(( SELECT ISNULL(SUM(di_header_wkf.imp_prima_neto_me),0) FROM di_header_wkf WHERE id_pv = @id_pv ), @cod_moneda) /* avillagran */ ,imp_suma_asegurada = dbo.RedondeaImporteEmision(( SELECT ISNULL(SUM(di_header_wkf.imp_suma_aseg_me),0) FROM di_header_wkf WHERE id_pv = @id_pv ), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_importe_wkf SET imp_prima = dbo.RedondeaImporteEmision(( SELECT ISNULL(SUM(di_header_wkf.imp_prima_neto_me),0) FROM di_header_wkf WHERE id_pv = @id_pv ), @cod_moneda) /* avillagran */ ,imp_suma_asegurada = dbo.RedondeaImporteEmision(( SELECT ISNULL(SUM(di_header_wkf.imp_suma_aseg_me),0) FROM di_header_wkf WHERE id_pv = @id_pv ), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_importe_wkf SET imp_prima = dbo.RedondeaImporteEmision(( SELECT ISNULL(SUM(di_header_wkf.imp_prima_neto_me),0) FROM di_header_wkf WHERE id_pv = @id_pv ), @cod_moneda) /* avillagran */ ,imp_suma_asegurada = dbo.RedondeaImporteEmision(( SELECT ISNULL(SUM(di_header_wkf.imp_suma_aseg_me),0) FROM di_header_wkf WHERE id_pv = @id_pv ), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_importe_wkf SET imp_prima = dbo.RedondeaImporteEmision(( SELECT ISNULL(SUM(di_header_wkf.imp_prima_neto_me),0) FROM di_header_wkf WHERE id_pv = @id_pv ), @cod_moneda) /* avillagran */ ,imp_suma_asegurada = dbo.RedondeaImporteEmision(( SELECT ISNULL(SUM(di_header_wkf.imp_suma_aseg_me),0) FROM di_header_wkf WHERE id_pv = @id_pv ), @cod_moneda) /* avillagran */ WHERE id_pv = @id_pv
                EXEC emi_consistencia_moneda @id_pv
                    EXEC dbo.revisa_importe_emision_tempdb_core
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                    UPDATE pv_pagador_cuota_wkf SET pv_pagador_cuota_wkf.imp_prima_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_prima_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_decreto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_decreto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_iva_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_iva_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_rec_fin_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_rec_fin_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_dto_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_dto_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_der_emi_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_der_emi_me * @imp_cambio), 0) /* avillagran */ ,pv_pagador_cuota_wkf.imp_premio_eq = dbo.RedondeaImporteEmision_trunca((pv_pagador_cuota_wkf.imp_premio_me * @imp_cambio), 0) /* avillagran */ WHERE id_pv = @id_pv
                EXEC emi_usp_carga_conceptos @id_pv = @id_pv, @cod_moneda = @cod_moneda, @cod_tipo_concepto = 2, @cod_concepto = @cod_concepto, @imp_concepto_me = @imp_gasto_emision
                    EXEC dbo.revisa_importe_emision_tempdb_core
                EXEC @sp_error = usp_ArmaPVImporteConcepto_wkf @id_pv = @id_pv, @cod_moneda = @cod_moneda, @cod_ramo = @cod_ramo, @sn_temporario = -1
                    exec usp_ArmaPVImporteConcepto_wkf_core @id_pv = @id_pv, @cod_moneda = @cod_moneda, @cod_ramo = @cod_ramo, @imp_base_calculo = @imp_base_calculo, @pje_recfin = @pje_recfin, @pje_iva = @pje_iva, @pje_deremi = @pje_deremi, @pje_descuento = @pje_descuento, @pje_decreto = @pje_decreto, @sn_temporario = @sn_temporario
                        EXEC dbo.revisa_importe_emision_tempdb_core
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 0, 2, 1, 1, 100, 0, imp_base_calculo * 29544.6900, 100, 0.00, dbo.RedondeaImporteEmision((imp_concepto * 29544.6900),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_importe_concepto_wkf WHERE id_pv = 50614011AND cod_moneda = 4 AND cod_tipo_concepto = 2 AND cod_concepto = 1
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 4, 2, 2, 2, 100, 0, 0, 100, 0.00, ISNULL(SUM(ISNULL(dbo.fn_GetConcep(id_pv, cod_moneda,2,2),0)),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_header_wkf WHERE id_pv = 50614011
                                IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                                IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                                RETURN dbo.RedondeaImporteEmision(@imp_concepto, @cod_moneda)
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 0, 2, 2, 2, 100, 0, imp_base_calculo * 29544.6900, 100, 0.00, dbo.RedondeaImporteEmision((imp_concepto * 29544.6900),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_importe_concepto_wkf WHERE id_pv = 50614011AND cod_moneda = 4 AND cod_tipo_concepto = 2 AND cod_concepto = 2
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 4, 2, 4, 3, 100, 0, 0, 100, 0.00, ISNULL(SUM(ISNULL(dbo.fn_GetConcep(id_pv, cod_moneda,2,4),0)),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_header_wkf WHERE id_pv = 50614011
                                IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                                SELECT @imp_concepto = dbo.fn_BaseConcepto(@id_pv_wkf, @cod_moneda,@cod_tipo_concepto,@cod_concepto) * (tp.pje_rec_fin / 100) FROM pv_header_wkf ph INNER JOIN pv_header ph2 on ph2.id_pv = ph.id_pv_cero INNER JOIN pv_pagador pp on pp.id_pv = ph2.id_pv INNER JOIN tppago tp ON tp.cod_ppago = pp.cod_ppago WHERE pp.id_pv = @id_pv_cero
                                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                                    IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                                    IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                                    SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                                RETURN dbo.RedondeaImporteEmision(@imp_concepto, @cod_moneda)
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 0, 2, 4, 3, 100, 0, imp_base_calculo * 29544.6900, 100, 0.00, dbo.RedondeaImporteEmision((imp_concepto * 29544.6900),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_importe_concepto_wkf WHERE id_pv = 50614011AND cod_moneda = 4 AND cod_tipo_concepto = 2 AND cod_concepto = 4
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 4, 2, 5, 4, 100, 0, 0, 100, 0.00, ISNULL(SUM(ISNULL(dbo.fn_GetConcep(id_pv, cod_moneda,2,5),0)),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_header_wkf WHERE id_pv = 50614011
                                IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                                IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                                SELECT @imp_concepto = dbo.fn_BaseConcepto(@id_pv_wkf, @cod_moneda,@cod_tipo_concepto,@cod_concepto) * (tp.pje_rec_fin / 100) FROM pv_header_wkf ph INNER JOIN pv_header ph2 on ph2.id_pv = ph.id_pv_cero INNER JOIN pv_pagador pp on pp.id_pv = ph2.id_pv INNER JOIN tppago tp ON tp.cod_ppago = pp.cod_ppago WHERE pp.id_pv = @id_pv_cero
                                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                                    IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                                    IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                                    SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                                RETURN dbo.RedondeaImporteEmision(@imp_concepto, @cod_moneda)
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 0, 2, 5, 4, 100, 0, imp_base_calculo * 29544.6900, 100, 0.00, dbo.RedondeaImporteEmision((imp_concepto * 29544.6900),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_importe_concepto_wkf WHERE id_pv = 50614011AND cod_moneda = 4 AND cod_tipo_concepto = 2 AND cod_concepto = 5
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 4, 2, 9, 5, 100, 0, 0, 100, 0.00, ISNULL(SUM(ISNULL(dbo.fn_GetConcep(id_pv, cod_moneda,2,9),0)),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_header_wkf WHERE id_pv = 50614011
                                IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                                IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                                RETURN dbo.RedondeaImporteEmision(@imp_concepto, @cod_moneda)
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 0, 2, 9, 5, 100, 0, imp_base_calculo * 29544.6900, 100, 0.00, dbo.RedondeaImporteEmision((imp_concepto * 29544.6900),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_importe_concepto_wkf WHERE id_pv = 50614011AND cod_moneda = 4 AND cod_tipo_concepto = 2 AND cod_concepto = 9
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 4, 2, 13, 6, 100, 0, 0, 100, 0.00, ISNULL(SUM(ISNULL(dbo.fn_GetConcep(id_pv, cod_moneda,2,13),0)),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_header_wkf WHERE id_pv = 50614011
                                IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                                IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                                RETURN dbo.RedondeaImporteEmision(@imp_concepto, @cod_moneda)
                            INSERT INTO pv_importe_concepto_wkf SELECT 50614011, 0, 2, 13, 6, 100, 0, imp_base_calculo * 29544.6900, 100, 0.00, dbo.RedondeaImporteEmision((imp_concepto * 29544.6900),0), 0, 0, 0, 0, 0, 0, 0 FROM pv_importe_concepto_wkf WHERE id_pv = 50614011AND cod_moneda = 4 AND cod_tipo_concepto = 2 AND cod_concepto = 13
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SET @imp_iva = dbo.RedondeaImporteEmision((@imp_iva * @imp_cambio), @cod_moneda)
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SET @imp_iva = dbo.RedondeaImporteEmision((@imp_iva * @imp_cambio), @cod_moneda)
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SET @imp_iva = dbo.RedondeaImporteEmision((@imp_iva * @imp_cambio), @cod_moneda)
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , pje_tasa = CASE WHEN dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto) = 0 THEN 0 ELSE isnull((imp_concepto / dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto)) * 100 ,0)END WHERE id_pv = @id_pv and cod_tipo_concepto = 2
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                    if dbo.emi_sn_nuevo_calc_recargo(@id_pv,-1) = 0
                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                    EXEC ACC.GET_TAX @codAbona = @cod_abona, @branchCode = @cod_suc, @individualId = @cod_aseg, @impTotal = @imp_prima, @codCpto = NULL, @agentTypeCode = NULL, @codUsuario = @cod_usuario, @factCorrela = NULL, @currencyId = 0, @currencyValue = @imp_cambio, @random = @id_pv, @codProcess = 9
                        exec dbo.spi_calculo_impuesto @cod_suc = @branchCode ,@cod_abona = @codAbona ,@cod_persona = @individualId ,@cambio = @currencyValue ,@cod_moneda =@currencyId ,@imp_total = @impTotal ,@cod_cpto = @codCpto ,@int_rnd = @random ,@cod_usuario = @codUsuario ,@nro_correla_fac = @factCorrela ,@cod_copto = @codCpto ,@cod_costo = NULL ,@cod_tipo_agente = @agentTypeCode ,@sn_recobro = NULL ,@fec_factura =@fecFactura ,@fec_pago =@fecPago ,@codProcess = @codProcess
                            EXEC emi_usp_recup_impuesto_persona @cod_ramo = @cod_ramo, @cod_abona = @cod_abona, @imp_total = @imp_total, @id_pv = @int_rnd, @id_persona = @id_persona, @cod_pais = @cod_pais
                            EXEC emi_usp_get_base_imponible @cod_impuesto = @cod_impuesto, @cod_usuario = @cod_usuario, @int_rnd = @int_rnd, @cod_condicion = @cod_condicion, @cod_proceso = @codProcess
                                EXEC revisa_importe_emision_tempdb_core
                                SET @BASECALCULO = @BASECALCULO * dbo.fn_PjePrimaAfecta(@int_rnd,@cod_proceso)
                                    if dbo.emi_sn_nuevo_calc_recargo(@id_pv,-1) = -1
                                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                                UPDATE tmp_calcula_imp SET imp_total = dbo.RedondeaImporteEmision(@BASECALCULO, @cod_moneda) WHERE cod_impuesto = @cod_impuesto AND cod_usuario = @cod_usuario AND int_rnd = @int_rnd AND cod_condicion = @cod_condicion AND cod_dpto = @cod_dpto
                            UPDATE tmp_calcula_imp SET tmp_calcula_imp.imp_acumulado = ISNULL([dbo].[fn_Baseimpuesto](@int_rnd, @cod_usuario),0) WHERE int_rnd = @int_rnd AND cod_usuario = @cod_usuario
                                SET @imp_ACUM = dbo.RedondeaImporteEmision(@imp_ACUM, @cod_moneda)
                            UPDATE tmp_calcula_imp SET tmp_calcula_imp.imp_acumulado = ISNULL([dbo].[fn_Baseimpuesto](@int_rnd, @cod_usuario),0) WHERE int_rnd = @int_rnd AND cod_usuario = @cod_usuario
                                SET @imp_ACUM = dbo.RedondeaImporteEmision(@imp_ACUM, @cod_moneda)
                                EXEC usp_calculo_impuesto_ramo_dev 31, 0, 1 , '0', 50614011, 276403, 0
                            EXEC emi_usp_get_base_imponible @cod_impuesto = @cod_impuesto, @cod_usuario = @cod_usuario, @int_rnd = @int_rnd, @cod_condicion = @cod_condicion, @cod_proceso = @codProcess
                                EXEC revisa_importe_emision_tempdb_core
                                UPDATE tmp_calcula_imp SET imp_total = dbo.RedondeaImporteEmision(@BASECALCULO, @cod_moneda) WHERE cod_impuesto = @cod_impuesto AND cod_usuario = @cod_usuario AND int_rnd = @int_rnd AND cod_condicion = @cod_condicion AND cod_dpto = @cod_dpto
                            UPDATE tmp_calcula_imp SET tmp_calcula_imp.imp_acumulado = ISNULL([dbo].[fn_Baseimpuesto](@int_rnd, @cod_usuario),0) WHERE int_rnd = @int_rnd AND cod_usuario = @cod_usuario
                                SET @imp_ACUM = dbo.RedondeaImporteEmision(@imp_ACUM, @cod_moneda)
                            UPDATE tmp_calcula_imp SET tmp_calcula_imp.imp_acumulado = ISNULL([dbo].[fn_Baseimpuesto](@int_rnd, @cod_usuario),0) WHERE int_rnd = @int_rnd AND cod_usuario = @cod_usuario
                                SET @imp_ACUM = dbo.RedondeaImporteEmision(@imp_ACUM, @cod_moneda)
                                EXEC usp_calculo_impuesto_ramo_dev 1, 1, 1 , '0', 50614011, 276403, 0
                        exec dbo.spi_consulta_imp @cod_abona = @codAbona ,@cod_persona = @individualId ,@cod_usuario = @codUsuario ,@cod_consulta = @codProcess ,@nro_correla_Fac = NULL ,@cod_tipo_agente = @agentTypeCode ,@RND = @random
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                            if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                        SET @imp_iva = dbo.RedondeaImporteEmision((@imp_iva * @imp_cambio), @cod_moneda)
                        SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                        SELECT @imp_concepto = dbo.fn_BaseConcepto(@id_pv_wkf, @cod_moneda,@cod_tipo_concepto,@cod_concepto) * (tp.pje_rec_fin / 100) FROM pv_header_wkf ph INNER JOIN pv_header ph2 on ph2.id_pv = ph.id_pv_cero INNER JOIN pv_pagador pp on pp.id_pv = ph2.id_pv INNER JOIN tppago tp ON tp.cod_ppago = pp.cod_ppago WHERE pp.id_pv = @id_pv_cero
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SET @imp_iva = dbo.RedondeaImporteEmision((@imp_iva * @imp_cambio), @cod_moneda)
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                        RETURN dbo.RedondeaImporteEmision(@imp_concepto, @cod_moneda)
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                        SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                        SELECT @imp_concepto = dbo.fn_BaseConcepto(@id_pv_wkf, @cod_moneda,@cod_tipo_concepto,@cod_concepto) * (tp.pje_rec_fin / 100) FROM pv_header_wkf ph INNER JOIN pv_header ph2 on ph2.id_pv = ph.id_pv_cero INNER JOIN pv_pagador pp on pp.id_pv = ph2.id_pv INNER JOIN tppago tp ON tp.cod_ppago = pp.cod_ppago WHERE pp.id_pv = @id_pv_cero
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        RETURN dbo.RedondeaImporteEmision(@imp_concepto, @cod_moneda)
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                            if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                        SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                        SELECT @imp_concepto = dbo.fn_BaseConcepto(@id_pv_wkf, @cod_moneda,@cod_tipo_concepto,@cod_concepto) * (tp.pje_rec_fin / 100) FROM pv_header_wkf ph INNER JOIN pv_header ph2 on ph2.id_pv = ph.id_pv_cero INNER JOIN pv_pagador pp on pp.id_pv = ph2.id_pv INNER JOIN tppago tp ON tp.cod_ppago = pp.cod_ppago WHERE pp.id_pv = @id_pv_cero
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                        RETURN dbo.RedondeaImporteEmision(@imp_concepto, @cod_moneda)
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                        IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                        IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                        SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                        IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()
                        SELECT @imp_concepto = dbo.fn_BaseConcepto(@id_pv_wkf, @cod_moneda,@cod_tipo_concepto,@cod_concepto) * (tp.pje_rec_fin / 100) FROM pv_header_wkf ph INNER JOIN pv_header ph2 on ph2.id_pv = ph.id_pv_cero INNER JOIN pv_pagador pp on pp.id_pv = ph2.id_pv INNER JOIN tppago tp ON tp.cod_ppago = pp.cod_ppago WHERE pp.id_pv = @id_pv_cero
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                            IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                                if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                            IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                            IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                            SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                        RETURN dbo.RedondeaImporteEmision(@imp_concepto, @cod_moneda)
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                    UPDATE pv_importe_concepto_wkf SET imp_base_calculo = isnull(dbo.fn_BaseConcepto(id_pv, cod_moneda,cod_tipo_concepto, cod_concepto),0) , imp_concepto = isnull(dbo.fn_GetConcep(@id_pv, pv_importe_concepto_wkf.cod_moneda,2,cod_concepto),0) WHERE id_pv = @id_pv and cod_tipo_concepto = 2 and (cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or cod_concepto = dbo.CONST_EMI_REC_FINC_EX())
                UPDATE pic SET imp_concepto = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda, pic.cod_tipo_concepto, pic.cod_concepto) * (tice.pje_tasa / 100) ELSE dbo.RedondeaImporteEmision(tice.imp_concepto_me, @cod_moneda) END, pje_tasa = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN tice.pje_tasa ELSE CASE WHEN ISNULL(dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto),0) = 0 THEN 0 ELSE (tice.imp_concepto_me / dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto)) * 100 END END FROM pv_importe_concepto_wkf pic INNER JOIN #tmp_imp_concepto_emi tice ON tice.id_pv = pic.id_pv AND tice.cod_tipo_concepto = pic.cod_tipo_concepto AND tice.cod_concepto = pic.cod_concepto WHERE pic.id_pv = @id_pv AND pic.cod_moneda = @cod_moneda
                UPDATE pic SET imp_concepto = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda, pic.cod_tipo_concepto, pic.cod_concepto) * (tice.pje_tasa / 100) ELSE dbo.RedondeaImporteEmision(tice.imp_concepto_me, @cod_moneda) END, pje_tasa = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN tice.pje_tasa ELSE CASE WHEN ISNULL(dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto),0) = 0 THEN 0 ELSE (tice.imp_concepto_me / dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto)) * 100 END END FROM pv_importe_concepto_wkf pic INNER JOIN #tmp_imp_concepto_emi tice ON tice.id_pv = pic.id_pv AND tice.cod_tipo_concepto = pic.cod_tipo_concepto AND tice.cod_concepto = pic.cod_concepto WHERE pic.id_pv = @id_pv AND pic.cod_moneda = @cod_moneda
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                    IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                    SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                UPDATE pic SET imp_concepto = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda, pic.cod_tipo_concepto, pic.cod_concepto) * (tice.pje_tasa / 100) ELSE dbo.RedondeaImporteEmision(tice.imp_concepto_me, @cod_moneda) END, pje_tasa = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN tice.pje_tasa ELSE CASE WHEN ISNULL(dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto),0) = 0 THEN 0 ELSE (tice.imp_concepto_me / dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto)) * 100 END END FROM pv_importe_concepto_wkf pic INNER JOIN #tmp_imp_concepto_emi tice ON tice.id_pv = pic.id_pv AND tice.cod_tipo_concepto = pic.cod_tipo_concepto AND tice.cod_concepto = pic.cod_concepto WHERE pic.id_pv = @id_pv AND pic.cod_moneda = @cod_moneda
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                    IF @cod_concepto <> 1 AND @cod_concepto <> dbo.CONST_EMI_DESCUENTO()
                    SET @imp_base = dbo.RedondeaImporteEmision((@imp_base - @imp_descuento), @cod_moneda)
                UPDATE pic SET imp_concepto = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda, pic.cod_tipo_concepto, pic.cod_concepto) * (tice.pje_tasa / 100) ELSE dbo.RedondeaImporteEmision(tice.imp_concepto_me, @cod_moneda) END, pje_tasa = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN tice.pje_tasa ELSE CASE WHEN ISNULL(dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto),0) = 0 THEN 0 ELSE (tice.imp_concepto_me / dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto)) * 100 END END FROM pv_importe_concepto_wkf pic INNER JOIN #tmp_imp_concepto_emi tice ON tice.id_pv = pic.id_pv AND tice.cod_tipo_concepto = pic.cod_tipo_concepto AND tice.cod_concepto = pic.cod_concepto WHERE pic.id_pv = @id_pv AND pic.cod_moneda = @cod_moneda
                UPDATE pic SET imp_concepto = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda, pic.cod_tipo_concepto, pic.cod_concepto) * (tice.pje_tasa / 100) ELSE dbo.RedondeaImporteEmision(tice.imp_concepto_me, @cod_moneda) END, pje_tasa = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN tice.pje_tasa ELSE CASE WHEN ISNULL(dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto),0) = 0 THEN 0 ELSE (tice.imp_concepto_me / dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto)) * 100 END END FROM pv_importe_concepto_wkf pic INNER JOIN #tmp_imp_concepto_emi tice ON tice.id_pv = pic.id_pv AND tice.cod_tipo_concepto = pic.cod_tipo_concepto AND tice.cod_concepto = pic.cod_concepto WHERE pic.id_pv = @id_pv AND pic.cod_moneda = @cod_moneda
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                    IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                    SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                UPDATE pic SET imp_concepto = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda, pic.cod_tipo_concepto, pic.cod_concepto) * (tice.pje_tasa / 100) ELSE dbo.RedondeaImporteEmision(tice.imp_concepto_me, @cod_moneda) END, pje_tasa = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN tice.pje_tasa ELSE CASE WHEN ISNULL(dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto),0) = 0 THEN 0 ELSE (tice.imp_concepto_me / dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto)) * 100 END END FROM pv_importe_concepto_wkf pic INNER JOIN #tmp_imp_concepto_emi tice ON tice.id_pv = pic.id_pv AND tice.cod_tipo_concepto = pic.cod_tipo_concepto AND tice.cod_concepto = pic.cod_concepto WHERE pic.id_pv = @id_pv AND pic.cod_moneda = @cod_moneda
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    SELECT @imp_descuento = ISNULL(SUM(imp_concepto),0) FROM pv_importe_concepto_wkf WHERE id_pv = @id_pv_wkf AND cod_tipo_concepto = 2 AND cod_concepto = dbo.CONST_EMI_DESCUENTO() AND cod_moneda = @cod_moneda
                    IF @cod_concepto = dbo.CONST_EMI_REC_FINC_AF()
                    IF dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = 0
                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                    SET @imp_base = dbo.RedondeaImporteEmision((@imp_base + ISNULL(@imp_iva,0)), @cod_moneda)
                UPDATE pic SET imp_concepto = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda, pic.cod_tipo_concepto, pic.cod_concepto) * (tice.pje_tasa / 100) ELSE dbo.RedondeaImporteEmision(tice.imp_concepto_me, @cod_moneda) END, pje_tasa = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN tice.pje_tasa ELSE CASE WHEN ISNULL(dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto),0) = 0 THEN 0 ELSE (tice.imp_concepto_me / dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto)) * 100 END END FROM pv_importe_concepto_wkf pic INNER JOIN #tmp_imp_concepto_emi tice ON tice.id_pv = pic.id_pv AND tice.cod_tipo_concepto = pic.cod_tipo_concepto AND tice.cod_concepto = pic.cod_concepto WHERE pic.id_pv = @id_pv AND pic.cod_moneda = @cod_moneda
                UPDATE pic SET imp_concepto = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda, pic.cod_tipo_concepto, pic.cod_concepto) * (tice.pje_tasa / 100) ELSE dbo.RedondeaImporteEmision(tice.imp_concepto_me, @cod_moneda) END, pje_tasa = CASE WHEN ISNULL(tice.imp_concepto_me,0) = 0 AND ISNULL(tice.pje_tasa,0) <> 0 THEN tice.pje_tasa ELSE CASE WHEN ISNULL(dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto),0) = 0 THEN 0 ELSE (tice.imp_concepto_me / dbo.fn_BaseConcepto(pic.id_pv, pic.cod_moneda,pic.cod_tipo_concepto, pic.cod_concepto)) * 100 END END FROM pv_importe_concepto_wkf pic INNER JOIN #tmp_imp_concepto_emi tice ON tice.id_pv = pic.id_pv AND tice.cod_tipo_concepto = pic.cod_tipo_concepto AND tice.cod_concepto = pic.cod_concepto WHERE pic.id_pv = @id_pv AND pic.cod_moneda = @cod_moneda
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                    IF (@cod_concepto = dbo.CONST_EMI_REC_FINC_AF() or @cod_concepto = dbo.CONST_EMI_REC_FINC_EX()) and dbo.emi_sn_nuevo_calc_recargo(@id_pv_wkf,-1) = -1
                        if @fec_emi < dbo.emi_fec_corte_calc_recargo()
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario
                    SELECT @imp_base = SUM(dci.imp_prima) ,@cod_usuario = pv.cod_usuario FROM di_cober_wkf dc INNER JOIN pv_header_wkf ph ON ph.id_pv = dc.id_pv INNER JOIN di_cober_imp_wkf dci ON dci.id_pv = dc.id_pv AND dci.cod_item = dc.cod_item AND dci.cod_ind_cob = dc.cod_ind_cob AND dci.cod_moneda = @cod_moneda INNER JOIN pv_varios_wkf pv ON pv.id_pv = dc.id_pv WHERE dc.id_pv = @id_pv_wkf AND dc.sn_acum_prima_total = -1 AND isnull(dc.sn_aplica_iva,0) = (case when @cod_concepto = dbo.CONST_EMI_REC_FINC_AF() then -1 else 0 end) GROUP BY pv.cod_usuario